FROM opennhp-base:latest  AS builder

WORKDIR /workdir

COPY . .

RUN echo "Building for architecture: ${TARGETARCH}"

# Add retry mechanism for go mod download to handle temporary network issues
RUN cd /workdir && cat Makefile && \
    for i in 1 2 3; do \
        echo "Attempt $i: downloading Go modules..." && \
        make init agentd test && break || \
        { echo "Attempt $i failed, retrying in 5 seconds..."; sleep 5; }; \
    done

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && \
    apt-get install -y  wget \
    ca-certificates \
    iptables \
    tcpdump \
    clang \
    ipset \
    nginx \
    git \
    curl \
    inetutils-ping \
    telnet \
    && rm -rf /var/lib/apt/lists/*
RUN groupadd -r nginx && \
    useradd -r -g nginx -s /bin/bash -d /home/nginx -m nginx

RUN mv /workdir/release/nhp-agent /nhp-agent
USER root

CMD ["tail", "-f", "/dev/null"]
#CMD ["nginx && /nhp-agent/nhp-agentd run"]
#CMD ["nginx"]