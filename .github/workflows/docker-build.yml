# Docker Build and Push to Tencent Cloud Container Registry
# 自动构建 nhp-server 和 nhp-ac Docker 镜像并推送到腾讯云容器镜像仓库
#
# ==================== 配置 GitHub Secrets ====================
# 在 GitHub 仓库设置中配置以下 Secrets：
# 路径: Settings -> Secrets and variables -> Actions -> New repository secret
#
#   - TENCENT_DOCKER_USERNAME: 腾讯云容器镜像服务用户名
#     例如: 100043899758
#   - TENCENT_DOCKER_PASSWORD: 腾讯云容器镜像服务密码
#     (在腾讯云控制台获取镜像仓库访问凭证)
#
# ==================== 触发条件 ====================
# 1. 推送到 main 分支时自动触发
# 2. 创建 v* 格式的 tag 时触发 (如 v1.0.0)
# 3. Pull Request 到 main 分支时仅构建不推送
# 4. 支持手动触发 (workflow_dispatch)
#
# ==================== 镜像标签 ====================
# - latest: 最新的 main 分支构建
# - v1.0.0: git tag 对应的版本
# - 20231230120000-abc1234: 时间戳 + commit SHA 前7位
# =============================================================

name: Build and Push Docker Images

on:
  push:
    branches: ["main"]
    tags:
      - "v*"
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      tag:
        description: "Docker image tag (default: latest)"
        required: false
        default: "latest"

env:
  REGISTRY: ccr.ccs.tencentyun.com
  IMAGE_PREFIX: hixiu

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 设置 Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 登录到腾讯云容器镜像仓库
      - name: Login to Tencent Cloud Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.TENCENT_DOCKER_USERNAME }}
          password: ${{ secrets.TENCENT_DOCKER_PASSWORD }}

      # 生成镜像标签
      - name: Generate image tags
        id: tags
        run: |
          # 默认标签
          TAG="latest"
          
          # 如果是手动触发，使用输入的标签
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          fi
          
          # 如果是 tag 推送，使用 git tag 作为 docker tag
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG="${{ github.ref_name }}"
          fi
          
          # 生成时间戳标签
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
          
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "timestamp_tag=${TIMESTAMP}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "Generated tags: ${TAG}, ${TIMESTAMP}-${SHORT_SHA}"

      # 构建并推送 nhp-server 镜像
      - name: Build and push nhp-server
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.server
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-server:${{ steps.tags.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-server:${{ steps.tags.outputs.timestamp_tag }}
          cache-from: type=gha,scope=server
          cache-to: type=gha,mode=max,scope=server
          build-args: |
            TARGETARCH=amd64

      # 构建并推送 nhp-ac 镜像
      - name: Build and push nhp-ac
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile.ac
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-ac:${{ steps.tags.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-ac:${{ steps.tags.outputs.timestamp_tag }}
          cache-from: type=gha,scope=ac
          cache-to: type=gha,mode=max,scope=ac
          build-args: |
            TARGETARCH=amd64

      # 输出构建结果
      - name: Print image info
        if: github.event_name != 'pull_request'
        run: |
          echo "============================================"
          echo "Docker images built and pushed successfully!"
          echo "============================================"
          echo ""
          echo "nhp-server images:"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-server:${{ steps.tags.outputs.tag }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-server:${{ steps.tags.outputs.timestamp_tag }}"
          echo ""
          echo "nhp-ac images:"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-ac:${{ steps.tags.outputs.tag }}"
          echo "  - ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-ac:${{ steps.tags.outputs.timestamp_tag }}"
          echo ""
          echo "To pull these images:"
          echo "  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-server:${{ steps.tags.outputs.tag }}"
          echo "  docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/nhp-ac:${{ steps.tags.outputs.tag }}"
